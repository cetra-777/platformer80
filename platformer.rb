# title:   game title
# author:  game developer, email, etc.
# desc:    short description
# site:    website link
# license: MIT License (change this to your license of choice)
# version: 0.1
# script:  ruby

class Projectile
  attr_accessor :x, :y, :dx, :dy, :active, :flip

  def initialize()
    @x = 0
    @y = 0
    @dx = 0
    @dy = 0
    @active = false
    @sprite = 265
    @flip = 0
  end

  def drawProjectile()
    spr(@sprite, @x, @y, 0, 1, @flip)
  end
end

class Player
  attr_accessor :x, :y

  def initialize()
    @x = 10
    @y = 10
    @dx = 0
    @dy = 0
    @w = 8
    @h = 8
    @speed = 1
    @sprite = 256
    @divisor = 30
    @flip = 0
    @jump_power = -3
    @direction = 1
    @projectile = Projectile.new()
  end

  def updatePlayer()
    movePlayer()
    draw_player()
    throwProjectile()
  end

  def draw_player()
    if @dx > 0
      @sprite = 258
      @divisor = 15
      @flip = 0
    elsif @dx < 0
      @sprite = 258
      @divisor = 15
      @flip = 1
    else
      @sprite = 256
      @divisor = 30
    end

    if @dy > 0
      @sprite = 262
      @divisor = 30
    elsif @dy < 0
      @sprite = 261
      @divisor = 30
    end
    spr(@sprite + ($t % 60).div(@divisor), @x, @y, 0, 1, @flip)
  end

  def movePlayer()
    # Horizontal Movement
    if btn(2)
      @direction = -1
      @dx = -@speed
    elsif btn(3)
      @direction = 1
      @dx = @speed
    else
      @dx = 0
    end

    # check for horizontal collisions
    u = @y + @dy
    d = @y + @dy + 7
    l = @x + @dx
    r = @x + @dx + 7

    if @dx < 0 and (solidTile?(l, u) or solidTile?(l, d))
      @dx = 0
    elsif @dx > 0 and (solidTile?(r, u) or solidTile?(r, d))
      @dx = 0
    end

    # bottom collisions
    if solidTile?(l, d + 1) or solidTile?(r, d + 1)
      @dy = 0
    else
      @dy += $GRAVITY
    end

    # Vertical Movement
    if btnp(5) or btnp(0) and @dy == 0
      @dy = @jump_power
    end

    # Top Collisions
    if @dy < 0 and (solidTile?(l, u) or solidTile?(r, u))
      @dy = 0
    end

    #update position
    @x += @dx
    @y += @dy
  end

  def throwProjectile()
    if @projectile.active
      @projectile.x += @projectile.dx
      if @projectile.x >= 0 and @projectile.x < 256
        @projectile.drawProjectile()
      else
        @projectile.active = false
      end
    elsif btnp(4)
      @projectile.active = true
      @projectile.flip = @direction
      @projectile.dx = (@speed + 1) * @direction
      @projectile.x = @x + (9 * @direction)
      @projectile.y = @y
    end

    # projectile map collisions
    if @projectile.active
      u = @projectile.y + @projectile.dy
      d = @projectile.y + @projectile.dy + 7
      l = @projectile.x + @projectile.dx
      r = @projectile.x + @projectile.dx + 7

      if @projectile.dx < 0 and (solidTile?(l, u) or solidTile?(l, d))
        @projectile.active = false
      elsif @projectile.dx > 0 and (solidTile?(r, u) or solidTile?(r, d))
        @projectile.active = false
      end
    end
  end
end

def solidTile?(x, y)
  return mget(x.div(8), y.div(8)).between?(1, 64)
end

# Constants
$GRAVITY = 0.2

# Variables
$t = 0
$player = Player.new()

def TIC()
  # Track time
  $t += 1
  cls()

  # Draw map
  map(0, 0, 30, 17, 0, 0, 0)

  # Player functions
  $player.updatePlayer()
end

# <TILES>
# 001:55555555656665566633656333333653343336533333356333343633333333e3
# 002:555555556555655666656563333536533336336338333333333e333333333343
# 003:55555555655565566565655636363656333633633233383333333333333333e3
# 004:00555555055565565565655655663656556333635633383355633333663333e3
# 005:555555006556555065565655656366553633365533234365333336553e333366
# 017:3333333333333e33334333333333333333333333313332333333333333333333
# 018:333333333332733333373333333332333333233331c332333c1c333333c33333
# 019:33333333333e332333eee333333ee33333ee3333333332333933333333333333
# 020:33333333323333433333c3333333cc33333c33333cc3333333c3331333333333
# 033:6666666655655565565556556666666656555655556555656666666600655600
# 034:6666666655655655565556566666666655655655656555656666666600655600
# 035:3333333344344434434443443333333343444344443444343333333300344300
# 036:3333333344344344434443433333333344344344343444343333333300344300
# 128:0065560000665600006566000065560000655600006656000065660000655600
# 129:0065560000656600006556000066560000656600006556000066560000655600
# 130:0034430000334300003433000034430000344300003343000034330000344300
# 131:0034430000343300003443000033430000343300003443000033430000344300
# </TILES>

# <SPRITES>
# 000:0033333000222220034cf4f00344444000022000002222000402d04000200d00
# 001:0033333000222220034cf4f00344434000222200040220400002d00000200d00
# 002:000333330222222220344cf40034444342222000000220000220d0000000d000
# 003:020333332022222200344cf4003444434222200000022000002d0000002d0000
# 004:000333330222222220344cf40034444342222000000220000dd0200000002000
# 005:000333332022222202344cf400344443422220000002200000d2000000d20000
# 006:000333330022222202344cf420344443022220004002200000d200000d200000
# 007:200333330222222200344cf4003444430000222000002204000002d00000002d
# 008:00000000033333000222220034cf4f00344434000022224004022d00000022dd
# 009:0000000000099900099bba909bcccba99bcccba9099bba900009990000000000
# </SPRITES>

# <MAP>
# 009:000000000000000000000000000000000012220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
# 010:000000000040500000000000000012220008180000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
# 011:000000004011115000000012220008180008180000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
# 012:000000001111111100000008180008180008180000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
# 013:203030203020203030203030202020202020202020202020202020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
# 014:111111111141211121113121111121414141112141414111112141414100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
# 015:211121311121111111111141312111212121211121212121211121212100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
# </MAP>

# <WAVES>
# 000:00000000ffffffff00000000ffffffff
# 001:0123456789abcdeffedcba9876543210
# 002:0123456789abcdef0123456789abcdef
# </WAVES>

# <SFX>
# 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304000000000
# </SFX>

# <TRACKS>
# 000:100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
# </TRACKS>

# <FLAGS>
# 000:00303030303000000000000000000000003030303000000000000000000000000010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
# </FLAGS>

# <PALETTE>
# 000:1a1c2c5d275db13e5375481ee5c7a0a7f07038b76425717929366f3b5dc941a6f673eff7f4f4f494b0c2566c86333c57
# </PALETTE>
